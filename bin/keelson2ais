#!/usr/bin/env python3

"""
Command line utility tool for outputting AIS encoded messages to stdout
from data received on a Zenoh session adhearing to the keelson protocol.
"""
import sys
import math
import time
import json
import logging
import argparse
import threading
from typing import Union
from contextlib import contextmanager

import zenoh
import skarv
import keelson
import skarv.utilities

from utils import *

logger = logging.getLogger("keelson2ais")

SUBJECTS = [
    # Message 1
    "location_fix",
    "rate_of_turn_degpm",
    "heading_true_north_deg",
    "course_over_ground_deg",
    "speed_over_ground_knots",
    "vessel_mmsi_number",

    # Message 5
    "draught_mean_m",
    "length_over_all_m",
    "breadth_over_all_m",
    "vessel_name",
    "vessel_call_sign",
    "vessel_imo_number"
]



@skarv.subscribe("location_fix")
def _(sample: skarv.Sample):
    # TODO: Fetch all necessary items from skarvs vault
    location_fix = sample.value
    rate_of_turn_degpm = skarv.get("rate_of_turn_degpm")
    heading_true_north_deg = skarv.get("heading_true_north_deg")
    course_over_ground_deg = skarv.get("course_over_ground_deg")
    speed_over_ground_knots = skarv.get("speed_over_ground_knots")
    vessel_mmsi_number = skarv.get("vessel_mmsi_number")
    # TODO: Create AIS Message 1
    # TODO: Output AIS Message 1 to stdout

@skarv.utilities.call_every(300, wait_first=True)
def _():
    # TODO: Fetch all necessary items from skarvs vault
    draught_mean_m = skarv.get("draught_mean_m")
    length_over_all_m = skarv.get("length_over_all_m")
    breadth_over_all_m = skarv.get("breadth_over_all_m")
    vessel_name = skarv.get("vessel_name")
    vessel_call_sign = skarv.get("vessel_call_sign")
    vessel_imo_number = skarv.get("vessel_imo_number")
    # TODO: Create AIS Message 5
    # TODO: Output AIS Message 5 to stdout
    pass

# Entrypoint
def main():
    parser = argparse.ArgumentParser(
        prog="keelson2ais",
        formatter_class=argparse.ArgumentDefaultsHelpFormatter,
    )

    parser.add_argument("--log-level", type=int, default=logging.INFO)

    parser.add_argument(
        "--mode",
        "-m",
        dest="mode",
        choices=["peer", "client"],
        type=str,
        help="The zenoh session mode.",
    )

    parser.add_argument(
        "--connect",
        action="append",
        type=str,
        help="Endpoints to connect to, in case multicast is not working. ex. tcp/localhost:7447",
    )

    parser.add_argument("-r", "--realm", type=str, required=True)
    parser.add_argument("-e", "--entity-id", type=str, required=True)

    for subject in SUBJECTS:
        parser.add_argument(f"--source_id_{subject}", type=str, default="**")

    # Parse arguments and start doing our thing
    args = parser.parse_args()

    # Setup logger
    logging.basicConfig(
        format="%(asctime)s %(levelname)s %(name)s %(message)s", level=args.log_level
    )
    logging.captureWarnings(True)

    # Put together zenoh session configuration
    conf = zenoh.Config()

    if args.mode is not None:
        conf.insert_json5("mode", json.dumps(args.mode))
    if args.connect is not None:
        conf.insert_json5("connect/endpoints", json.dumps(args.connect))

    def _forward_zenoh_to_skarv()

    # Construct session and run
    logger.info("Opening Zenoh session...")
    with zenoh.open(conf) as session:

        def into_skarv(sample: zenoh.Sample):
            subject = keelson.get_subject_from_pubsub_key(sample.key_expr)
            _, _, payload = keelson.uncover(sample.payload)
            proto_message = keelson.decode_protobuf_payload_from_type_name(
                payload,
                keelson.get_subject_schema(subject)
                )
            skarv.put(subject, proto_message)

        # Create subscribers
        for subject in SUBJECTS:
            session.declare_subscriber(
                keelson.construct_pubsub_key(
                    args.realm,
                    args.entity_id,
                    subject,
                    args[f"source-id_{subject}"],
                ),
                into_skarv
            )



if __name__ == "__main__":
    main()
